{"ast":null,"code":"/*\n * grunt-mock-s3\n * https://github.com/MathieuLoutre/grunt-mock-s3\n *\n * Copyright (c) 2013 Mathieu Triay\n * Licensed under the MIT license.\n */\n'use strict';\n\nvar _ = require('underscore');\n\nvar fs = require('fs-extra');\n\nvar crypto = require('crypto');\n\nvar path = require('path');\n\nvar Buffer = require('buffer').Buffer;\n\nvar Promise = require('bluebird');\n\nvar path = require('path');\n\nvar config = {}; // Gathered from http://stackoverflow.com/questions/5827612/node-js-fs-readdir-recursive-directory-search\n\nfunction walk(dir) {\n  var results = [];\n  var list = fs.readdirSync(dir);\n  list.forEach(function (file) {\n    file = dir + '/' + file;\n    var stat = fs.statSync(file);\n\n    if (stat && stat.isDirectory()) {\n      results = results.concat(walk(file));\n    } else {\n      results.push(file);\n    }\n  });\n  return results;\n}\n/** Add basePath to selected keys */\n\n\nfunction applyBasePath(search) {\n  if (_.isUndefined(config.basePath)) {\n    return search;\n  }\n\n  var modifyKeys = ['Bucket', 'CopySource'];\n\n  var ret = _.mapObject(search, function (value, key) {\n    if (_.indexOf(modifyKeys, key) === -1) {\n      return value;\n    } else {\n      if (config.basePath == null || value == null) {\n        return;\n      }\n\n      return path.join(config.basePath, value);\n    }\n  });\n\n  return ret;\n}\n/** FakeStream object for mocking S3 streams */\n\n\nfunction FakeStream(search) {\n  this.src = search.Bucket + '/' + search.Key;\n}\n\nFakeStream.prototype.createReadStream = function () {\n  return fs.createReadStream(this.src);\n};\n/**\n * Decorate a method to enable calling `.promise()` on the returned value to get a Promise, when the method\n * is initially called without a callback.\n * @decorator\n * @private\n */\n\n\nfunction createPromisable(wrapped) {\n  return function () {\n    var self = this;\n    var promisified = Promise.promisify(wrapped, {\n      context: self\n    });\n    var args = [].slice.call(arguments);\n    var callback = null;\n    var lastArgIndex = Math.min(args.length - 1, wrapped.length);\n\n    if (args.length >= 1) {\n      var lastArg = args[lastArgIndex];\n\n      if (_.isFunction(lastArg)) {\n        callback = lastArg;\n      }\n    }\n\n    if (!_.isFunction(callback)) {\n      return {\n        createReadStream: function () {\n          this.send();\n\n          if (this._returned instanceof FakeStream) {\n            return this._returned.createReadStream();\n          }\n        },\n        promise: function () {\n          return promisified.apply(self, args);\n        },\n        send: function (cb) {\n          args.push(cb);\n          this._returned = wrapped.apply(self, args);\n        }\n      };\n    } else {\n      wrapped.apply(self, args);\n    }\n  };\n}\n/** Mocks key pieces of the amazon s3 sdk */\n\n\nfunction S3Mock(options) {\n  if (!_.isUndefined(options) && !_.isUndefined(options.params)) {\n    this.defaultOptions = _.extend({}, applyBasePath(options.params));\n  }\n\n  this.config = {\n    update: function () {}\n  };\n}\n\nS3Mock.prototype = {\n  objectMetadataDictionary: [],\n  objectTaggingDictionary: [],\n  listObjectsV2: function (searchV2, callback) {\n    var searchV1 = _(searchV2).clone(); // Marker in V1 is StartAfter in V2\n    // ContinuationToken trumps marker on subsequent requests.\n\n\n    searchV1.Marker = searchV2.ContinuationToken || searchV2.StartAfter;\n    this.listObjects(searchV1, function (err, resultV1) {\n      var resultV2 = _(resultV1).clone(); // Rewrite NextMarker to NextContinuationToken\n\n\n      resultV2.NextContinuationToken = resultV1.NextMarker; // Remember original ContinuationToken and StartAfter\n\n      resultV2.ContinuationToken = searchV2.ContinuationToken;\n      resultV2.StartAfter = searchV2.StartAfter;\n      callback(err, resultV2);\n    });\n  },\n  listObjects: function (search, callback) {\n    search = _.extend({}, this.defaultOptions, applyBasePath(search));\n    var files = walk(search.Bucket);\n\n    var filteredFiles = _.filter(files, function (file) {\n      return !search.Prefix || file.replace(search.Bucket + '/', '').indexOf(search.Prefix) === 0;\n    });\n\n    var start = 0;\n    var truncated = false;\n\n    if (search.Marker) {\n      var isPartial;\n\n      var markerFile = _(filteredFiles).find(function (file) {\n        var marker = search.Bucket + '/' + search.Marker;\n\n        if (file.indexOf(marker) === 0) {\n          isPartial = file.length !== marker.length;\n          return true;\n        }\n      });\n\n      var startFile;\n\n      if (isPartial) {\n        startFile = filteredFiles[filteredFiles.indexOf(markerFile)];\n      } else {\n        startFile = filteredFiles[filteredFiles.indexOf(markerFile) + 1];\n      }\n\n      start = filteredFiles.indexOf(startFile);\n    }\n\n    if (start === -1) {\n      filteredFiles = [];\n    } else {\n      filteredFiles = _.rest(filteredFiles, start);\n    }\n\n    if (filteredFiles.length > Math.min(1000, search.MaxKeys || 1000)) {\n      truncated = true;\n      filteredFiles = filteredFiles.slice(0, Math.min(1000, search.MaxKeys || 1000));\n    }\n\n    var result = {\n      Contents: _.map(filteredFiles, function (path) {\n        var stat = fs.statSync(path);\n        return {\n          Key: path.replace(search.Bucket + '/', ''),\n          ETag: '\"' + crypto.createHash('md5').update(fs.readFileSync(path)).digest('hex') + '\"',\n          LastModified: stat.mtime,\n          Size: stat.size\n        };\n      }),\n      CommonPrefixes: _.reduce(filteredFiles, function (prefixes, path) {\n        var prefix = path.replace(search.Bucket + '/', '').split('/').slice(0, -1).join('/').concat('/');\n        return prefixes.indexOf(prefix) === -1 ? prefixes.concat([prefix]) : prefixes;\n      }, []).map(function (prefix) {\n        return {\n          Prefix: prefix\n        };\n      }),\n      IsTruncated: truncated\n    };\n\n    if (search.Marker) {\n      result.Marker = search.Marker;\n    }\n\n    if (truncated && search.Delimiter) {\n      result.NextMarker = _.last(result.Contents).Key;\n    }\n\n    callback(null, result);\n  },\n  deleteObjects: function (search, callback) {\n    search = _.extend({}, this.defaultOptions, applyBasePath(search));\n    var deleted = [];\n    var errors = [];\n\n    _.each(search.Delete.Objects, function (file) {\n      if (fs.existsSync(search.Bucket + '/' + file.Key)) {\n        deleted.push(file);\n        fs.unlinkSync(search.Bucket + '/' + file.Key);\n      } else {\n        errors.push(file);\n      }\n    });\n\n    if (errors.length > 0) {\n      callback('Error deleting objects', {\n        Errors: errors,\n        Deleted: deleted\n      });\n    } else {\n      callback(null, {\n        Deleted: deleted\n      });\n    }\n  },\n  deleteObject: function (search, callback) {\n    search = _.extend({}, this.defaultOptions, applyBasePath(search));\n\n    if (fs.existsSync(search.Bucket + '/' + search.Key)) {\n      fs.unlinkSync(search.Bucket + '/' + search.Key);\n      callback(null, true);\n    } else {\n      callback(null, {});\n    }\n  },\n  headObject: function (search, callback) {\n    var self = this;\n    search = _.extend({}, this.defaultOptions, applyBasePath(search));\n\n    if (!callback) {\n      return new FakeStream(search);\n    } else {\n      fs.readFile(search.Bucket + '/' + search.Key, function (err, data) {\n        if (!err) {\n          var props = {\n            Key: search.Key,\n            ETag: '\"' + crypto.createHash('md5').update(data).digest('hex') + '\"',\n            ContentLength: data.length\n          };\n\n          if (self.objectMetadataDictionary[search.Key]) {\n            props.Metadata = self.objectMetadataDictionary[search.Key];\n          }\n\n          callback(null, props);\n        } else {\n          if (err.code === 'ENOENT') {\n            err.statusCode = 404;\n          }\n\n          callback(err, search);\n        }\n      });\n    }\n  },\n  getObject: function (search, callback) {\n    var self = this;\n    search = _.extend({}, this.defaultOptions, applyBasePath(search));\n\n    if (!callback) {\n      return new FakeStream(search);\n    } else {\n      var path = search.Bucket + '/' + search.Key;\n      fs.readFile(path, function (err, data) {\n        if (!err) {\n          var stat = fs.statSync(path);\n          var props = {\n            Key: search.Key,\n            ETag: '\"' + crypto.createHash('md5').update(data).digest('hex') + '\"',\n            Body: data,\n            LastModified: stat.mtime,\n            ContentLength: data.length\n          };\n\n          if (self.objectMetadataDictionary[search.Key]) {\n            props.Metadata = self.objectMetadataDictionary[search.Key];\n          }\n\n          callback(null, props);\n        } else {\n          if (err.code === 'ENOENT') {\n            return callback({\n              cfId: undefined,\n              code: 'NoSuchKey',\n              message: 'The specified key does not exist.',\n              name: 'NoSuchKey',\n              region: null,\n              statusCode: 404\n            }, search);\n          }\n\n          callback(err, search);\n        }\n      });\n    }\n  },\n  copyObject: function (search, callback) {\n    search = _.extend({}, this.defaultOptions, applyBasePath(search));\n    fs.mkdirsSync(path.dirname(search.Bucket + '/' + search.Key));\n    fs.copy(decodeURIComponent(search.CopySource), search.Bucket + '/' + search.Key, function (err, data) {\n      callback(err, search);\n    });\n  },\n  createBucket: function (params, callback) {\n    var err = null; // param prop tests - these need to be done here to avoid issues with defaulted values\n\n    if (typeof params === 'object' && params !== null) {\n      // null is an object, at least in older V8's\n      // Bucket - required, String\n      if (typeof params.Bucket !== 'string' || params.Bucket.length <= 0) {\n        // NOTE: This *will not* match the error provided by the AWS SDK - but that's chasing a moving target\n        err = new Error(\"Mock-AWS-S3: Argument 'params' must contain a 'Bucket' (String) property\");\n      } // Should we check the remaining props of the params Object? (probably)\n\n    } else {\n      err = new Error(\"Mock-AWS-S3: Argument 'params' must be an Object\");\n    } // Note: this.defaultOptions is an object which was passed in to the constructor\n\n\n    var opts = _.extend({}, this.defaultOptions, applyBasePath(params)); // If the params object is well-formed...\n\n\n    if (err === null) {\n      // We'll assume that if basePath is set, it's correctly set (i.e. data type etc.) and if not...\n      // we'll default to the local dir (which seems to be the existing behaviour - in e.g. putObject)\n      // It would be nicer if there were a strongly defined default\n      var bucketPath = opts.basePath || '';\n      bucketPath += opts.Bucket;\n      fs.mkdirs(bucketPath, function (err) {\n        return callback(err);\n      });\n    } else {\n      // ...if the params object is not well-formed, fail fast\n      return callback(err);\n    }\n  },\n\n  /**\n   * Deletes a bucket. Behaviour as createBucket\n   * @param params {Bucket: bucketName}. Name of bucket to delete\n   * @param callback\n   * @returns void\n   */\n  deleteBucket: function (params, callback) {\n    var err = null;\n\n    if (typeof params === 'object' && params !== null) {\n      if (typeof params.Bucket !== 'string' || params.Bucket.length <= 0) {\n        err = new Error(\"Mock-AWS-S3: Argument 'params' must contain a 'Bucket' (String) property\");\n      }\n    } else {\n      err = new Error(\"Mock-AWS-S3: Argument 'params' must be an Object\");\n    }\n\n    var opts = _.extend({}, this.defaultOptions, applyBasePath(params));\n\n    if (err !== null) {\n      callback(err);\n    }\n\n    var bucketPath = opts.basePath || '';\n    bucketPath += opts.Bucket;\n    fs.remove(bucketPath, function (err) {\n      return callback(err);\n    });\n  },\n  putObject: function (search, callback) {\n    search = _.extend({}, this.defaultOptions, applyBasePath(search));\n\n    if (search.Metadata) {\n      this.objectMetadataDictionary[search.Key] = search.Metadata;\n    }\n\n    if (typeof search.Tagging === 'string') {\n      // URL query parameter encoded\n      var tags = {};\n      var tagSet = []; // quick'n'dirty parsing into an object (does not support hashes or arrays)\n\n      search.Tagging.split('&').forEach(function (part) {\n        var item = part.split('=');\n        tags[decodeURIComponent(item[0])] = decodeURIComponent(item[1]);\n      }); // expand into tagset\n\n      Object.keys(tags).forEach(function (key) {\n        tagSet.push({\n          Key: key,\n          Value: tags[key]\n        });\n      });\n      this.objectTaggingDictionary[search.Key] = tagSet;\n    }\n\n    var dest = search.Bucket + '/' + search.Key;\n    var sendCallback = null;\n\n    var done = function () {\n      if (typeof sendCallback === 'function') {\n        sendCallback.apply(this, arguments);\n      }\n\n      if (typeof callback === 'function') {\n        callback.apply(this, arguments);\n      }\n    };\n\n    if (typeof search.Body === 'string') {\n      search.Body = Buffer.from(search.Body);\n    }\n\n    if (search.Body instanceof Buffer) {\n      fs.createFileSync(dest);\n      fs.writeFile(dest, search.Body, function (err) {\n        done(err, {\n          Location: dest,\n          Key: search.Key,\n          Bucket: search.Bucket\n        });\n      });\n    } else {\n      fs.mkdirsSync(path.dirname(dest));\n      var stream = fs.createWriteStream(dest);\n      stream.on('finish', function () {\n        done(null, true);\n      });\n      search.Body.on('error', function (err) {\n        done(err);\n      });\n      stream.on('error', function (err) {\n        done(err);\n      });\n      search.Body.pipe(stream);\n    }\n\n    return {\n      send: function (cb) {\n        sendCallback = cb;\n      }\n    };\n  },\n  getObjectTagging: function (search, callback) {\n    var self = this;\n    this.headObject(search, function (err, props) {\n      if (err) {\n        return callback(err);\n      } else {\n        return callback(null, {\n          VersionId: '1',\n          TagSet: self.objectTaggingDictionary[search.Key] || []\n        });\n      }\n    });\n  },\n  putObjectTagging: function (search, callback) {\n    var self = this;\n\n    if (!search.Tagging || !search.Tagging.TagSet) {\n      return callback(new Error('Tagging.TagSet required'));\n    }\n\n    this.headObject(search, function (err, props) {\n      if (err) {\n        return callback(err);\n      } else {\n        self.objectTaggingDictionary[search.Key] = search.Tagging.TagSet;\n        return callback(null, {\n          VersionId: '1'\n        });\n      }\n    });\n  },\n  upload: function (search, options, callback) {\n    if (typeof options === 'function' && callback === undefined) {\n      callback = options;\n      options = null;\n    }\n\n    if (options && options.tags) {\n      if (!Array.isArray(options.tags)) {\n        return callback(new Error('Tags must be specified as an array; ' + typeof options.tags + ' provided'));\n      }\n    }\n\n    return this.putObject(search, function (err, data) {\n      if (options && options.tags) {\n        // https://github.com/aws/aws-sdk-js/pull/1425\n        return this.putObjectTagging({\n          Bucket: search.Bucket,\n          Key: search.Key,\n          Tagging: {\n            TagSet: options.tags\n          }\n        }, function (err) {\n          if (err) {\n            return callback(err);\n          }\n\n          return callback(null, data);\n        });\n      }\n\n      return callback(err, data);\n    }.bind(this));\n  },\n  getSignedUrl: function (operation, params, callback) {\n    var url = 'https://s3.us-east-2.amazonaws.com/' + params.Bucket + '/' + params.Key + '?X-Amz-Date=20170720T182534Z&X-Amz-SignedHeaders=host' + '&X-Amz-Credential=ASIAIYLQNVRRFNZOCFBA%2F20170720%2' + 'Fus-east-2%2Fs3%2Faws4_request&X-Amz-Algorithm=AWS4-HMAC-SHA256&X' + '-Amz-Expires=604800&X-Amz-Security-Token=FQoDYXdzEJP%2F%2F%2F%2F%2' + 'F%2F%2F%2F%2F%2FwEaDOLWx95j90zPxGh7WSLdAVnoYoKC4gjrrR1xbokFWRRwutm' + 'uAmOxaIVcQqOy%2Fqxy%2FXQt3Iz%2FohuEEmI7%2FHPzShy%2BfgQtvfUeDaojrAx' + '5q8fG9P1KuIfcedfkiU%2BCxpM2foyCGlXzoZuNlcF8ohm%2BaM3wh4%2BxQ%2FpSh' + 'Ll18cKiKEiw0QF1UQGj%2FsiEqzoM81vOSUVWL9SpTTkVq8EQHY1chYKBkBWt7eIQc' + 'xjTI2dQeYOohlrbnZ5Y1%2F1cxPgrbk6PkNFO3whAoliSjyRC8e4TSjIY2j3V6d9fU' + 'y4%2Fp6nLZIf9wuERL7xW9PjE6eZbKOHnw8sF&X-Amz-Signature=a14b3065ab82' + '2105e8d7892eb5dcc455ddd603c61e47520774a7289178af9ecc';\n\n    switch (operation) {\n      case 'getObject':\n        this.headObject(params, function (err, props) {\n          if (err) {\n            err.statusCode = 404;\n          }\n\n          if (callback) {\n            if (err) {\n              callback(err, null);\n            } else {\n              callback(null, url);\n            }\n          } else {\n            if (err) {\n              throw new Error(err);\n            }\n\n            return url;\n          }\n        });\n        break;\n\n      case 'putObject':\n        if (!params.Bucket || !params.Key) {\n          throw new Error({\n            statusCode: 404\n          });\n        }\n\n        return url;\n\n      default:\n    }\n  }\n};\n\n_.forEach(S3Mock.prototype, function (value, key, obj) {\n  if (_.isFunction(value)) {\n    obj[key] = createPromisable(value);\n  }\n});\n\nexports.config = config;\n\nexports.S3 = function (options) {\n  return new S3Mock(options);\n};","map":{"version":3,"sources":["D:/ReactJS/reactjsstart/my-app/node_modules/mock-aws-s3/lib/mock.js"],"names":["_","require","fs","crypto","path","Buffer","Promise","config","walk","dir","results","list","readdirSync","forEach","file","stat","statSync","isDirectory","concat","push","applyBasePath","search","isUndefined","basePath","modifyKeys","ret","mapObject","value","key","indexOf","join","FakeStream","src","Bucket","Key","prototype","createReadStream","createPromisable","wrapped","self","promisified","promisify","context","args","slice","call","arguments","callback","lastArgIndex","Math","min","length","lastArg","isFunction","send","_returned","promise","apply","cb","S3Mock","options","params","defaultOptions","extend","update","objectMetadataDictionary","objectTaggingDictionary","listObjectsV2","searchV2","searchV1","clone","Marker","ContinuationToken","StartAfter","listObjects","err","resultV1","resultV2","NextContinuationToken","NextMarker","files","filteredFiles","filter","Prefix","replace","start","truncated","isPartial","markerFile","find","marker","startFile","rest","MaxKeys","result","Contents","map","ETag","createHash","readFileSync","digest","LastModified","mtime","Size","size","CommonPrefixes","reduce","prefixes","prefix","split","IsTruncated","Delimiter","last","deleteObjects","deleted","errors","each","Delete","Objects","existsSync","unlinkSync","Errors","Deleted","deleteObject","headObject","readFile","data","props","ContentLength","Metadata","code","statusCode","getObject","Body","cfId","undefined","message","name","region","copyObject","mkdirsSync","dirname","copy","decodeURIComponent","CopySource","createBucket","Error","opts","bucketPath","mkdirs","deleteBucket","remove","putObject","Tagging","tags","tagSet","part","item","Object","keys","Value","dest","sendCallback","done","from","createFileSync","writeFile","Location","stream","createWriteStream","on","pipe","getObjectTagging","VersionId","TagSet","putObjectTagging","upload","Array","isArray","bind","getSignedUrl","operation","url","obj","exports","S3"],"mappings":"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","sourcesContent":["/*\n * grunt-mock-s3\n * https://github.com/MathieuLoutre/grunt-mock-s3\n *\n * Copyright (c) 2013 Mathieu Triay\n * Licensed under the MIT license.\n */\n\n'use strict'\n\nvar _ = require('underscore')\nvar fs = require('fs-extra')\nvar crypto = require('crypto')\nvar path = require('path')\nvar Buffer = require('buffer').Buffer\nvar Promise = require('bluebird')\nvar path = require('path')\nvar config = {}\n\n// Gathered from http://stackoverflow.com/questions/5827612/node-js-fs-readdir-recursive-directory-search\nfunction walk (dir) {\n\tvar results = []\n\tvar list = fs.readdirSync(dir)\n\n\tlist.forEach(function (file) {\n\t\tfile = dir + '/' + file\n\t\tvar stat = fs.statSync(file)\n\n\t\tif (stat && stat.isDirectory()) {\n\t\t\tresults = results.concat(walk(file))\n\t\t}\n\t\telse {\n\t\t\tresults.push(file)\n\t\t}\n\t})\n\n\treturn results\n}\n\n/** Add basePath to selected keys */\nfunction applyBasePath (search) {\n\tif (_.isUndefined(config.basePath)) {\n\t\treturn search\n\t}\n\n\tvar modifyKeys = ['Bucket', 'CopySource']\n\n\tvar ret = _.mapObject(search, function (value, key) {\n\t\tif (_.indexOf(modifyKeys, key) === -1) {\n\t\t\treturn value\n\t\t}\n\t\telse {\n\t\t\tif (config.basePath == null || value == null) {\n\t\t\t\treturn\n\t\t\t}\n\t\t\treturn path.join(config.basePath, value)\n\t\t}\n\t})\n\n\treturn ret\n}\n\n/** FakeStream object for mocking S3 streams */\nfunction FakeStream (search) {\n\tthis.src = search.Bucket + '/' + search.Key\n}\n\nFakeStream.prototype.createReadStream = function () {\n\treturn fs.createReadStream(this.src)\n}\n\n/**\n * Decorate a method to enable calling `.promise()` on the returned value to get a Promise, when the method\n * is initially called without a callback.\n * @decorator\n * @private\n */\nfunction createPromisable (wrapped) {\n\treturn function () {\n\t\tvar self = this\n\t\tvar promisified = Promise.promisify(wrapped, { context: self })\n\t\tvar args = [].slice.call(arguments)\n\t\tvar callback = null\n\t\tvar lastArgIndex = Math.min(args.length - 1, wrapped.length)\n\n\t\tif (args.length >= 1) {\n\t\t\tvar lastArg = args[lastArgIndex]\n\n\t\t\tif (_.isFunction(lastArg)) {\n\t\t\t\tcallback = lastArg\n\t\t\t}\n\t\t}\n\n\t\tif (!_.isFunction(callback)) {\n\t\t\treturn {\n\t\t\t\tcreateReadStream: function () {\n\t\t\t\t\tthis.send()\n\n\t\t\t\t\tif (this._returned instanceof FakeStream) {\n\t\t\t\t\t\treturn this._returned.createReadStream()\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tpromise: function () {\n\t\t\t\t\treturn promisified.apply(self, args)\n\t\t\t\t},\n\t\t\t\tsend: function (cb) {\n\t\t\t\t\targs.push(cb)\n\t\t\t\t\tthis._returned = wrapped.apply(self, args)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\twrapped.apply(self, args)\n\t\t}\n\t}\n}\n\n/** Mocks key pieces of the amazon s3 sdk */\nfunction S3Mock (options) {\n\tif (!_.isUndefined(options) && !_.isUndefined(options.params)) {\n\t\tthis.defaultOptions = _.extend({}, applyBasePath(options.params))\n\t}\n\n\tthis.config = {\n\t\tupdate: function () {}\n\t}\n}\n\nS3Mock.prototype = {\n\tobjectMetadataDictionary: [],\n\tobjectTaggingDictionary: [],\n\n\tlistObjectsV2: function (searchV2, callback) {\n\t\tvar searchV1 = _(searchV2).clone()\n\t\t// Marker in V1 is StartAfter in V2\n\t\t// ContinuationToken trumps marker on subsequent requests.\n\t\tsearchV1.Marker = searchV2.ContinuationToken || searchV2.StartAfter\n\n\t\tthis.listObjects(searchV1, function (err, resultV1) {\n\t\t\tvar resultV2 = _(resultV1).clone()\n\t\t\t// Rewrite NextMarker to NextContinuationToken\n\t\t\tresultV2.NextContinuationToken = resultV1.NextMarker\n\t\t\t// Remember original ContinuationToken and StartAfter\n\t\t\tresultV2.ContinuationToken = searchV2.ContinuationToken\n\t\t\tresultV2.StartAfter = searchV2.StartAfter\n\t\t\tcallback(err, resultV2)\n\t\t})\n\t},\n\n\tlistObjects: function (search, callback) {\n\t\tsearch = _.extend({}, this.defaultOptions, applyBasePath(search))\n\t\tvar files = walk(search.Bucket)\n\n\t\tvar filteredFiles = _.filter(files, function (file) {\n\t\t\treturn !search.Prefix || file.replace(search.Bucket + '/', '').indexOf(search.Prefix) === 0\n\t\t})\n\t\tvar start = 0\n\t\tvar truncated = false\n\n\t\tif (search.Marker) {\n\t\t\tvar isPartial\n\t\t\tvar markerFile = _(filteredFiles).find(function (file) {\n\t\t\t\tvar marker = search.Bucket + '/' + search.Marker\n\n\t\t\t\tif (file.indexOf(marker) === 0) {\n\t\t\t\t\tisPartial = file.length !== marker.length\n\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t})\n\n\t\t\tvar startFile\n\n\t\t\tif (isPartial) {\n\t\t\t\tstartFile = filteredFiles[filteredFiles.indexOf(markerFile)]\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstartFile = filteredFiles[filteredFiles.indexOf(markerFile) + 1]\n\t\t\t}\n\n\t\t\tstart = filteredFiles.indexOf(startFile)\n\t\t}\n\n\t\tif (start === -1) {\n\t\t\tfilteredFiles = []\n\t\t}\n\t\telse {\n\t\t\tfilteredFiles = _.rest(filteredFiles, start)\n\t\t}\n\n\t\tif (filteredFiles.length > Math.min(1000, search.MaxKeys || 1000)) {\n\t\t\ttruncated = true\n\t\t\tfilteredFiles = filteredFiles.slice(0, Math.min(1000, search.MaxKeys || 1000))\n\t\t}\n\n\t\tvar result = {\n\t\t\tContents: _.map(filteredFiles, function (path) {\n\t\t\t\tvar stat = fs.statSync(path)\n\n\t\t\t\treturn {\n\t\t\t\t\tKey: path.replace(search.Bucket + '/', ''),\n\t\t\t\t\tETag: '\"' + crypto.createHash('md5').update(fs.readFileSync(path)).digest('hex') + '\"',\n\t\t\t\t\tLastModified: stat.mtime,\n\t\t\t\t\tSize: stat.size\n\t\t\t\t}\n\t\t\t}),\n\t\t\tCommonPrefixes: _.reduce(filteredFiles, function (prefixes, path) {\n\t\t\t\tvar prefix = path\n\t\t\t\t\t.replace(search.Bucket + '/', '')\n\t\t\t\t\t.split('/')\n\t\t\t\t\t.slice(0, -1)\n\t\t\t\t\t.join('/')\n\t\t\t\t\t.concat('/')\n\n\t\t\t\treturn prefixes.indexOf(prefix) === -1 ? prefixes.concat([prefix]) : prefixes\n\t\t\t}, []).map(function (prefix) {\n\t\t\t\treturn {\n\t\t\t\t\tPrefix: prefix\n\t\t\t\t}\n\t\t\t}),\n\t\t\tIsTruncated: truncated\n\t\t}\n\n\t\tif (search.Marker) {\n\t\t\tresult.Marker = search.Marker\n\t\t}\n\n\t\tif (truncated && search.Delimiter) {\n\t\t\tresult.NextMarker = _.last(result.Contents).Key\n\t\t}\n\n\t\tcallback(null, result)\n\t},\n\n\tdeleteObjects: function (search, callback) {\n\t\tsearch = _.extend({}, this.defaultOptions, applyBasePath(search))\n\n\t\tvar deleted = []\n\t\tvar errors = []\n\n\t\t_.each(search.Delete.Objects, function (file) {\n\t\t\tif (fs.existsSync(search.Bucket + '/' + file.Key)) {\n\t\t\t\tdeleted.push(file)\n\t\t\t\tfs.unlinkSync(search.Bucket + '/' + file.Key)\n\t\t\t}\n\t\t\telse {\n\t\t\t\terrors.push(file)\n\t\t\t}\n\t\t})\n\n\t\tif (errors.length > 0) {\n\t\t\tcallback('Error deleting objects', { Errors: errors, Deleted: deleted })\n\t\t}\n\t\telse {\n\t\t\tcallback(null, { Deleted: deleted })\n\t\t}\n\t},\n\n\tdeleteObject: function (search, callback) {\n\t\tsearch = _.extend({}, this.defaultOptions, applyBasePath(search))\n\n\t\tif (fs.existsSync(search.Bucket + '/' + search.Key)) {\n\t\t\tfs.unlinkSync(search.Bucket + '/' + search.Key)\n\t\t\tcallback(null, true)\n\t\t}\n\t\telse {\n\t\t\tcallback(null, {})\n\t\t}\n\t},\n\n\theadObject: function (search, callback) {\n\t\tvar self = this\n\n\t\tsearch = _.extend({}, this.defaultOptions, applyBasePath(search))\n\n\t\tif (!callback) {\n\t\t\treturn new FakeStream(search)\n\t\t}\n\t\telse {\n\t\t\tfs.readFile(search.Bucket + '/' + search.Key, function (err, data) {\n\t\t\t\tif (!err) {\n\t\t\t\t\tvar props = {\n\t\t\t\t\t\tKey: search.Key,\n\t\t\t\t\t\tETag: '\"' + crypto.createHash('md5').update(data).digest('hex') + '\"',\n\t\t\t\t\t\tContentLength: data.length\n\t\t\t\t\t}\n\n\t\t\t\t\tif (self.objectMetadataDictionary[search.Key]) {\n\t\t\t\t\t\tprops.Metadata = self.objectMetadataDictionary[search.Key]\n\t\t\t\t\t}\n\n\t\t\t\t\tcallback(null, props)\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (err.code === 'ENOENT') {\n\t\t\t\t\t\terr.statusCode = 404\n\t\t\t\t\t}\n\n\t\t\t\t\tcallback(err, search)\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tgetObject: function (search, callback) {\n\t\tvar self = this\n\t\tsearch = _.extend({}, this.defaultOptions, applyBasePath(search))\n\n\t\tif (!callback) {\n\t\t\treturn new FakeStream(search)\n\t\t}\n\t\telse {\n\t\t\tvar path = search.Bucket + '/' + search.Key\n\n\t\t\tfs.readFile(path, function (err, data) {\n\t\t\t\tif (!err) {\n\t\t\t\t\tvar stat = fs.statSync(path)\n\n\t\t\t\t\tvar props = {\n\t\t\t\t\t\tKey: search.Key,\n\t\t\t\t\t\tETag: '\"' + crypto.createHash('md5').update(data).digest('hex') + '\"',\n\t\t\t\t\t\tBody: data,\n\t\t\t\t\t\tLastModified: stat.mtime,\n\t\t\t\t\t\tContentLength: data.length\n\t\t\t\t\t}\n\n\t\t\t\t\tif (self.objectMetadataDictionary[search.Key]) {\n\t\t\t\t\t\tprops.Metadata = self.objectMetadataDictionary[search.Key]\n\t\t\t\t\t}\n\n\t\t\t\t\tcallback(null, props)\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (err.code === 'ENOENT') {\n\t\t\t\t\t\treturn callback({\n\t\t\t\t\t\t\tcfId: undefined,\n\t\t\t\t\t\t\tcode: 'NoSuchKey',\n\t\t\t\t\t\t\tmessage: 'The specified key does not exist.',\n\t\t\t\t\t\t\tname: 'NoSuchKey',\n\t\t\t\t\t\t\tregion: null,\n\t\t\t\t\t\t\tstatusCode: 404\n\t\t\t\t\t\t}, search)\n\t\t\t\t\t}\n\n\t\t\t\t\tcallback(err, search)\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tcopyObject: function (search, callback) {\n\t\tsearch = _.extend({}, this.defaultOptions, applyBasePath(search))\n\n\t\tfs.mkdirsSync(path.dirname(search.Bucket + '/' + search.Key))\n\t\tfs.copy(decodeURIComponent(search.CopySource), search.Bucket + '/' + search.Key, function (err, data) {\n\t\t\tcallback(err, search)\n\t\t})\n\t},\n\n\tcreateBucket: function (params, callback) {\n\t\tvar err = null\n\n\t\t// param prop tests - these need to be done here to avoid issues with defaulted values\n\t\tif (typeof (params) === 'object' && params !== null) { // null is an object, at least in older V8's\n\t\t\t// Bucket - required, String\n\t\t\tif (typeof (params.Bucket) !== 'string' || params.Bucket.length <= 0) {\n\t\t\t\t// NOTE: This *will not* match the error provided by the AWS SDK - but that's chasing a moving target\n\t\t\t\terr = new Error(\"Mock-AWS-S3: Argument 'params' must contain a 'Bucket' (String) property\")\n\t\t\t}\n\n\t\t\t// Should we check the remaining props of the params Object? (probably)\n\t\t}\n\t\telse {\n\t\t\terr = new Error(\"Mock-AWS-S3: Argument 'params' must be an Object\")\n\t\t}\n\n\t\t// Note: this.defaultOptions is an object which was passed in to the constructor\n\t\tvar opts = _.extend({}, this.defaultOptions, applyBasePath(params))\n\n\t\t// If the params object is well-formed...\n\t\tif (err === null) {\n\t\t\t// We'll assume that if basePath is set, it's correctly set (i.e. data type etc.) and if not...\n\t\t\t// we'll default to the local dir (which seems to be the existing behaviour - in e.g. putObject)\n\t\t\t// It would be nicer if there were a strongly defined default\n\t\t\tvar bucketPath = opts.basePath || ''\n\t\t\tbucketPath += opts.Bucket\n\n\t\t\tfs.mkdirs(bucketPath, function (err) {\n\t\t\t\treturn callback(err)\n\t\t\t})\n\t\t}\n\t\telse { // ...if the params object is not well-formed, fail fast\n\t\t\treturn callback(err)\n\t\t}\n\t},\n\n\t/**\n\t * Deletes a bucket. Behaviour as createBucket\n\t * @param params {Bucket: bucketName}. Name of bucket to delete\n\t * @param callback\n\t * @returns void\n\t */\n\tdeleteBucket: function (params, callback) {\n\t\tvar err = null\n\n\t\tif (typeof (params) === 'object' && params !== null) {\n\t\t\tif (typeof (params.Bucket) !== 'string' || params.Bucket.length <= 0) {\n\t\t\t\terr = new Error(\"Mock-AWS-S3: Argument 'params' must contain a 'Bucket' (String) property\")\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\terr = new Error(\"Mock-AWS-S3: Argument 'params' must be an Object\")\n\t\t}\n\n\t\tvar opts = _.extend({}, this.defaultOptions, applyBasePath(params))\n\n\t\tif (err !== null) {\n\t\t\tcallback(err)\n\t\t}\n\n\t\tvar bucketPath = opts.basePath || ''\n\t\tbucketPath += opts.Bucket\n\n\t\tfs.remove(bucketPath, function (err) {\n\t\t\treturn callback(err)\n\t\t})\n\t},\n\n\tputObject: function (search, callback) {\n\t\tsearch = _.extend({}, this.defaultOptions, applyBasePath(search))\n\n\t\tif (search.Metadata) {\n\t\t\tthis.objectMetadataDictionary[search.Key] = search.Metadata\n\t\t}\n\n\t\tif (typeof search.Tagging === 'string') {\n\t\t\t// URL query parameter encoded\n\t\t\tvar tags = {}\n\t\t\tvar tagSet = []\n\n\t\t\t// quick'n'dirty parsing into an object (does not support hashes or arrays)\n\t\t\tsearch.Tagging.split('&').forEach(function (part) {\n\t\t\t\tvar item = part.split('=')\n\t\t\t\ttags[decodeURIComponent(item[0])] = decodeURIComponent(item[1])\n\t\t\t})\n\n\t\t\t// expand into tagset\n\t\t\tObject.keys(tags).forEach(function (key) {\n\t\t\t\ttagSet.push({\n\t\t\t\t\tKey: key,\n\t\t\t\t\tValue: tags[key]\n\t\t\t\t})\n\t\t\t})\n\n\t\t\tthis.objectTaggingDictionary[search.Key] = tagSet\n\t\t}\n\n\t\tvar dest = search.Bucket + '/' + search.Key\n\n\t\tvar sendCallback = null\n\n\t\tvar done = function () {\n\t\t\tif (typeof sendCallback === 'function') {\n\t\t\t\tsendCallback.apply(this, arguments)\n\t\t\t}\n\n\t\t\tif (typeof callback === 'function') {\n\t\t\t\tcallback.apply(this, arguments)\n\t\t\t}\n\t\t}\n\n\t\tif (typeof search.Body === 'string') {\n\t\t\tsearch.Body = Buffer.from(search.Body)\n\t\t}\n\n\t\tif (search.Body instanceof Buffer) {\n\t\t\tfs.createFileSync(dest)\n\n\t\t\tfs.writeFile(dest, search.Body, function (err) {\n\t\t\t\tdone(err, { Location: dest, Key: search.Key, Bucket: search.Bucket })\n\t\t\t})\n\t\t}\n\t\telse {\n\t\t\tfs.mkdirsSync(path.dirname(dest))\n\n\t\t\tvar stream = fs.createWriteStream(dest)\n\n\t\t\tstream.on('finish', function () {\n\t\t\t\tdone(null, true)\n\t\t\t})\n\n\t\t\tsearch.Body.on('error', function (err) {\n\t\t\t\tdone(err)\n\t\t\t})\n\n\t\t\tstream.on('error', function (err) {\n\t\t\t\tdone(err)\n\t\t\t})\n\n\t\t\tsearch.Body.pipe(stream)\n\t\t}\n\n\t\treturn {\n\t\t\tsend: function (cb) {\n\t\t\t\tsendCallback = cb\n\t\t\t}\n\t\t}\n\t},\n\n\tgetObjectTagging: function (search, callback) {\n\t\tvar self = this\n\n\t\tthis.headObject(search, function (err, props) {\n\t\t\tif (err) {\n\t\t\t\treturn callback(err)\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn callback(null, {\n\t\t\t\t\tVersionId: '1',\n\t\t\t\t\tTagSet: self.objectTaggingDictionary[search.Key] || []\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\t},\n\n\tputObjectTagging: function (search, callback) {\n\t\tvar self = this\n\n\t\tif (!search.Tagging || !search.Tagging.TagSet) {\n\t\t\treturn callback(new Error('Tagging.TagSet required'))\n\t\t}\n\n\t\tthis.headObject(search, function (err, props) {\n\t\t\tif (err) {\n\t\t\t\treturn callback(err)\n\t\t\t}\n\t\t\telse {\n\t\t\t\tself.objectTaggingDictionary[search.Key] = search.Tagging.TagSet\n\n\t\t\t\treturn callback(null, {\n\t\t\t\t\tVersionId: '1'\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\t},\n\n\tupload: function (search, options, callback) {\n\t\tif (typeof options === 'function' && callback === undefined) {\n\t\t\tcallback = options\n\t\t\toptions = null\n\t\t}\n\n\t\tif (options && options.tags) {\n\t\t\tif (!Array.isArray(options.tags)) {\n\t\t\t\treturn callback(new Error('Tags must be specified as an array; ' + typeof options.tags + ' provided'))\n\t\t\t}\n\t\t}\n\n\t\treturn this.putObject(search, function (err, data) {\n\t\t\tif (options && options.tags) {\n\t\t\t\t// https://github.com/aws/aws-sdk-js/pull/1425\n\t\t\t\treturn this.putObjectTagging({\n\t\t\t\t\tBucket: search.Bucket,\n\t\t\t\t\tKey: search.Key,\n\t\t\t\t\tTagging: {\n\t\t\t\t\t\tTagSet: options.tags\n\t\t\t\t\t}\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn callback(err)\n\t\t\t\t\t}\n\n\t\t\t\t\treturn callback(null, data)\n\t\t\t\t})\n\t\t\t}\n\n\t\t\treturn callback(err, data)\n\t\t}.bind(this))\n\t},\n\n\tgetSignedUrl: function (operation, params, callback) {\n\t\tvar url = 'https://s3.us-east-2.amazonaws.com/' +\n\t\t\tparams.Bucket +\n\t\t\t'/' + params.Key +\n\t\t\t'?X-Amz-Date=20170720T182534Z&X-Amz-SignedHeaders=host' +\n\t\t\t'&X-Amz-Credential=ASIAIYLQNVRRFNZOCFBA%2F20170720%2' +\n\t\t\t'Fus-east-2%2Fs3%2Faws4_request&X-Amz-Algorithm=AWS4-HMAC-SHA256&X' +\n\t\t\t'-Amz-Expires=604800&X-Amz-Security-Token=FQoDYXdzEJP%2F%2F%2F%2F%2' +\n\t\t\t'F%2F%2F%2F%2F%2FwEaDOLWx95j90zPxGh7WSLdAVnoYoKC4gjrrR1xbokFWRRwutm' +\n\t\t\t'uAmOxaIVcQqOy%2Fqxy%2FXQt3Iz%2FohuEEmI7%2FHPzShy%2BfgQtvfUeDaojrAx' +\n\t\t\t'5q8fG9P1KuIfcedfkiU%2BCxpM2foyCGlXzoZuNlcF8ohm%2BaM3wh4%2BxQ%2FpSh' +\n\t\t\t'Ll18cKiKEiw0QF1UQGj%2FsiEqzoM81vOSUVWL9SpTTkVq8EQHY1chYKBkBWt7eIQc' +\n\t\t\t'xjTI2dQeYOohlrbnZ5Y1%2F1cxPgrbk6PkNFO3whAoliSjyRC8e4TSjIY2j3V6d9fU' +\n\t\t\t'y4%2Fp6nLZIf9wuERL7xW9PjE6eZbKOHnw8sF&X-Amz-Signature=a14b3065ab82' +\n\t\t\t'2105e8d7892eb5dcc455ddd603c61e47520774a7289178af9ecc'\n\n\t\tswitch (operation) {\n\t\t\tcase 'getObject':\n\t\t\t\tthis.headObject(params, function (err, props) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\terr.statusCode = 404\n\t\t\t\t\t}\n\t\t\t\t\tif (callback) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\tcallback(err, null)\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tcallback(null, url)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\tthrow new Error(err)\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn url\n\t\t\t\t\t}\n\t\t\t\t})\n\n\t\t\t\tbreak\n\t\t\tcase 'putObject':\n\t\t\t\tif (!params.Bucket || !params.Key) {\n\t\t\t\t\tthrow new Error({ statusCode: 404 })\n\t\t\t\t}\n\n\t\t\t\treturn url\n\t\t\tdefault:\n\t\t}\n\t}\n}\n\n_.forEach(S3Mock.prototype, function (value, key, obj) {\n\tif (_.isFunction(value)) {\n\t\tobj[key] = createPromisable(value)\n\t}\n})\n\nexports.config = config\n\nexports.S3 = function (options) {\n\treturn new S3Mock(options)\n}\n"]},"metadata":{},"sourceType":"script"}