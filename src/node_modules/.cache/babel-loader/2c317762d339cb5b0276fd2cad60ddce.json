{"ast":null,"code":"var ProtoList = require('proto-list'),\n    path = require('path'),\n    fs = require('fs'),\n    ini = require('ini'),\n    EE = require('events').EventEmitter,\n    url = require('url'),\n    http = require('http');\n\nvar exports = module.exports = function () {\n  var args = [].slice.call(arguments),\n      conf = new ConfigChain();\n\n  while (args.length) {\n    var a = args.shift();\n    if (a) conf.push('string' === typeof a ? json(a) : a);\n  }\n\n  return conf;\n}; //recursively find a file...\n\n\nvar find = exports.find = function () {\n  var rel = path.join.apply(null, [].slice.call(arguments));\n\n  function find(start, rel) {\n    var file = path.join(start, rel);\n\n    try {\n      fs.statSync(file);\n      return file;\n    } catch (err) {\n      if (path.dirname(start) !== start) // root\n        return find(path.dirname(start), rel);\n    }\n  }\n\n  return find(__dirname, rel);\n};\n\nvar parse = exports.parse = function (content, file, type) {\n  content = '' + content; // if we don't know what it is, try json and fall back to ini\n  // if we know what it is, then it must be that.\n\n  if (!type) {\n    try {\n      return JSON.parse(content);\n    } catch (er) {\n      return ini.parse(content);\n    }\n  } else if (type === 'json') {\n    if (this.emit) {\n      try {\n        return JSON.parse(content);\n      } catch (er) {\n        this.emit('error', er);\n      }\n    } else {\n      return JSON.parse(content);\n    }\n  } else {\n    return ini.parse(content);\n  }\n};\n\nvar json = exports.json = function () {\n  var args = [].slice.call(arguments).filter(function (arg) {\n    return arg != null;\n  });\n  var file = path.join.apply(null, args);\n  var content;\n\n  try {\n    content = fs.readFileSync(file, 'utf-8');\n  } catch (err) {\n    return;\n  }\n\n  return parse(content, file, 'json');\n};\n\nvar env = exports.env = function (prefix, env) {\n  env = env || process.env;\n  var obj = {};\n  var l = prefix.length;\n\n  for (var k in env) {\n    if (k.indexOf(prefix) === 0) obj[k.substring(l)] = env[k];\n  }\n\n  return obj;\n};\n\nexports.ConfigChain = ConfigChain;\n\nfunction ConfigChain() {\n  EE.apply(this);\n  ProtoList.apply(this, arguments);\n  this._awaiting = 0;\n  this._saving = 0;\n  this.sources = {};\n} // multi-inheritance-ish\n\n\nvar extras = {\n  constructor: {\n    value: ConfigChain\n  }\n};\nObject.keys(EE.prototype).forEach(function (k) {\n  extras[k] = Object.getOwnPropertyDescriptor(EE.prototype, k);\n});\nConfigChain.prototype = Object.create(ProtoList.prototype, extras);\n\nConfigChain.prototype.del = function (key, where) {\n  // if not specified where, then delete from the whole chain, scorched\n  // earth style\n  if (where) {\n    var target = this.sources[where];\n    target = target && target.data;\n\n    if (!target) {\n      return this.emit('error', new Error('not found ' + where));\n    }\n\n    delete target[key];\n  } else {\n    for (var i = 0, l = this.list.length; i < l; i++) {\n      delete this.list[i][key];\n    }\n  }\n\n  return this;\n};\n\nConfigChain.prototype.set = function (key, value, where) {\n  var target;\n\n  if (where) {\n    target = this.sources[where];\n    target = target && target.data;\n\n    if (!target) {\n      return this.emit('error', new Error('not found ' + where));\n    }\n  } else {\n    target = this.list[0];\n\n    if (!target) {\n      return this.emit('error', new Error('cannot set, no confs!'));\n    }\n  }\n\n  target[key] = value;\n  return this;\n};\n\nConfigChain.prototype.get = function (key, where) {\n  if (where) {\n    where = this.sources[where];\n    if (where) where = where.data;\n    if (where && Object.hasOwnProperty.call(where, key)) return where[key];\n    return undefined;\n  }\n\n  return this.list[0][key];\n};\n\nConfigChain.prototype.save = function (where, type, cb) {\n  if (typeof type === 'function') cb = type, type = null;\n  var target = this.sources[where];\n\n  if (!target || !(target.path || target.source) || !target.data) {\n    // TODO: maybe save() to a url target could be a PUT or something?\n    // would be easy to swap out with a reddis type thing, too\n    return this.emit('error', new Error('bad save target: ' + where));\n  }\n\n  if (target.source) {\n    var pref = target.prefix || '';\n    Object.keys(target.data).forEach(function (k) {\n      target.source[pref + k] = target.data[k];\n    });\n    return this;\n  }\n\n  var type = type || target.type;\n  var data = target.data;\n\n  if (target.type === 'json') {\n    data = JSON.stringify(data);\n  } else {\n    data = ini.stringify(data);\n  }\n\n  this._saving++;\n  fs.writeFile(target.path, data, 'utf8', function (er) {\n    this._saving--;\n\n    if (er) {\n      if (cb) return cb(er);else return this.emit('error', er);\n    }\n\n    if (this._saving === 0) {\n      if (cb) cb();\n      this.emit('save');\n    }\n  }.bind(this));\n  return this;\n};\n\nConfigChain.prototype.addFile = function (file, type, name) {\n  name = name || file;\n  var marker = {\n    __source__: name\n  };\n  this.sources[name] = {\n    path: file,\n    type: type\n  };\n  this.push(marker);\n\n  this._await();\n\n  fs.readFile(file, 'utf8', function (er, data) {\n    if (er) this.emit('error', er);\n    this.addString(data, file, type, marker);\n  }.bind(this));\n  return this;\n};\n\nConfigChain.prototype.addEnv = function (prefix, env, name) {\n  name = name || 'env';\n  var data = exports.env(prefix, env);\n  this.sources[name] = {\n    data: data,\n    source: env,\n    prefix: prefix\n  };\n  return this.add(data, name);\n};\n\nConfigChain.prototype.addUrl = function (req, type, name) {\n  this._await();\n\n  var href = url.format(req);\n  name = name || href;\n  var marker = {\n    __source__: name\n  };\n  this.sources[name] = {\n    href: href,\n    type: type\n  };\n  this.push(marker);\n  http.request(req, function (res) {\n    var c = [];\n    var ct = res.headers['content-type'];\n\n    if (!type) {\n      type = ct.indexOf('json') !== -1 ? 'json' : ct.indexOf('ini') !== -1 ? 'ini' : href.match(/\\.json$/) ? 'json' : href.match(/\\.ini$/) ? 'ini' : null;\n      marker.type = type;\n    }\n\n    res.on('data', c.push.bind(c)).on('end', function () {\n      this.addString(Buffer.concat(c), href, type, marker);\n    }.bind(this)).on('error', this.emit.bind(this, 'error'));\n  }.bind(this)).on('error', this.emit.bind(this, 'error')).end();\n  return this;\n};\n\nConfigChain.prototype.addString = function (data, file, type, marker) {\n  data = this.parse(data, file, type);\n  this.add(data, marker);\n  return this;\n};\n\nConfigChain.prototype.add = function (data, marker) {\n  if (marker && typeof marker === 'object') {\n    var i = this.list.indexOf(marker);\n\n    if (i === -1) {\n      return this.emit('error', new Error('bad marker'));\n    }\n\n    this.splice(i, 1, data);\n    marker = marker.__source__;\n    this.sources[marker] = this.sources[marker] || {};\n    this.sources[marker].data = data; // we were waiting for this.  maybe emit 'load'\n\n    this._resolve();\n  } else {\n    if (typeof marker === 'string') {\n      this.sources[marker] = this.sources[marker] || {};\n      this.sources[marker].data = data;\n    } // trigger the load event if nothing was already going to do so.\n\n\n    this._await();\n\n    this.push(data);\n    process.nextTick(this._resolve.bind(this));\n  }\n\n  return this;\n};\n\nConfigChain.prototype.parse = exports.parse;\n\nConfigChain.prototype._await = function () {\n  this._awaiting++;\n};\n\nConfigChain.prototype._resolve = function () {\n  this._awaiting--;\n  if (this._awaiting === 0) this.emit('load', this);\n};","map":{"version":3,"sources":["D:/node_modules/npm/node_modules/config-chain/index.js"],"names":["ProtoList","require","path","fs","ini","EE","EventEmitter","url","http","exports","module","args","slice","call","arguments","conf","ConfigChain","length","a","shift","push","json","find","rel","join","apply","start","file","statSync","err","dirname","__dirname","parse","content","type","JSON","er","emit","filter","arg","readFileSync","env","prefix","process","obj","l","k","indexOf","substring","_awaiting","_saving","sources","extras","constructor","value","Object","keys","prototype","forEach","getOwnPropertyDescriptor","create","del","key","where","target","data","Error","i","list","set","get","hasOwnProperty","undefined","save","cb","source","pref","stringify","writeFile","bind","addFile","name","marker","__source__","_await","readFile","addString","addEnv","add","addUrl","req","href","format","request","res","c","ct","headers","match","on","Buffer","concat","end","splice","_resolve","nextTick"],"mappings":"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","sourcesContent":["var ProtoList = require('proto-list')\r\n  , path = require('path')\r\n  , fs = require('fs')\r\n  , ini = require('ini')\r\n  , EE = require('events').EventEmitter\r\n  , url = require('url')\r\n  , http = require('http')\r\n\r\nvar exports = module.exports = function () {\r\n  var args = [].slice.call(arguments)\r\n    , conf = new ConfigChain()\r\n\r\n  while(args.length) {\r\n    var a = args.shift()\r\n    if(a) conf.push\r\n          ( 'string' === typeof a\r\n            ? json(a)\r\n            : a )\r\n  }\r\n\r\n  return conf\r\n}\r\n\r\n//recursively find a file...\r\n\r\nvar find = exports.find = function () {\r\n  var rel = path.join.apply(null, [].slice.call(arguments))\r\n\r\n  function find(start, rel) {\r\n    var file = path.join(start, rel)\r\n    try {\r\n      fs.statSync(file)\r\n      return file\r\n    } catch (err) {\r\n      if(path.dirname(start) !== start) // root\r\n        return find(path.dirname(start), rel)\r\n    }\r\n  }\r\n  return find(__dirname, rel)\r\n}\r\n\r\nvar parse = exports.parse = function (content, file, type) {\r\n  content = '' + content\r\n  // if we don't know what it is, try json and fall back to ini\r\n  // if we know what it is, then it must be that.\r\n  if (!type) {\r\n    try { return JSON.parse(content) }\r\n    catch (er) { return ini.parse(content) }\r\n  } else if (type === 'json') {\r\n    if (this.emit) {\r\n      try { return JSON.parse(content) }\r\n      catch (er) { this.emit('error', er) }\r\n    } else {\r\n      return JSON.parse(content)\r\n    }\r\n  } else {\r\n    return ini.parse(content)\r\n  }\r\n}\r\n\r\nvar json = exports.json = function () {\r\n  var args = [].slice.call(arguments).filter(function (arg) { return arg != null })\r\n  var file = path.join.apply(null, args)\r\n  var content\r\n  try {\r\n    content = fs.readFileSync(file,'utf-8')\r\n  } catch (err) {\r\n    return\r\n  }\r\n  return parse(content, file, 'json')\r\n}\r\n\r\nvar env = exports.env = function (prefix, env) {\r\n  env = env || process.env\r\n  var obj = {}\r\n  var l = prefix.length\r\n  for(var k in env) {\r\n    if(k.indexOf(prefix) === 0)\r\n      obj[k.substring(l)] = env[k]\r\n  }\r\n\r\n  return obj\r\n}\r\n\r\nexports.ConfigChain = ConfigChain\r\nfunction ConfigChain () {\r\n  EE.apply(this)\r\n  ProtoList.apply(this, arguments)\r\n  this._awaiting = 0\r\n  this._saving = 0\r\n  this.sources = {}\r\n}\r\n\r\n// multi-inheritance-ish\r\nvar extras = {\r\n  constructor: { value: ConfigChain }\r\n}\r\nObject.keys(EE.prototype).forEach(function (k) {\r\n  extras[k] = Object.getOwnPropertyDescriptor(EE.prototype, k)\r\n})\r\nConfigChain.prototype = Object.create(ProtoList.prototype, extras)\r\n\r\nConfigChain.prototype.del = function (key, where) {\r\n  // if not specified where, then delete from the whole chain, scorched\r\n  // earth style\r\n  if (where) {\r\n    var target = this.sources[where]\r\n    target = target && target.data\r\n    if (!target) {\r\n      return this.emit('error', new Error('not found '+where))\r\n    }\r\n    delete target[key]\r\n  } else {\r\n    for (var i = 0, l = this.list.length; i < l; i ++) {\r\n      delete this.list[i][key]\r\n    }\r\n  }\r\n  return this\r\n}\r\n\r\nConfigChain.prototype.set = function (key, value, where) {\r\n  var target\r\n\r\n  if (where) {\r\n    target = this.sources[where]\r\n    target = target && target.data\r\n    if (!target) {\r\n      return this.emit('error', new Error('not found '+where))\r\n    }\r\n  } else {\r\n    target = this.list[0]\r\n    if (!target) {\r\n      return this.emit('error', new Error('cannot set, no confs!'))\r\n    }\r\n  }\r\n  target[key] = value\r\n  return this\r\n}\r\n\r\nConfigChain.prototype.get = function (key, where) {\r\n  if (where) {\r\n    where = this.sources[where]\r\n    if (where) where = where.data\r\n    if (where && Object.hasOwnProperty.call(where, key)) return where[key]\r\n    return undefined\r\n  }\r\n  return this.list[0][key]\r\n}\r\n\r\nConfigChain.prototype.save = function (where, type, cb) {\r\n  if (typeof type === 'function') cb = type, type = null\r\n  var target = this.sources[where]\r\n  if (!target || !(target.path || target.source) || !target.data) {\r\n    // TODO: maybe save() to a url target could be a PUT or something?\r\n    // would be easy to swap out with a reddis type thing, too\r\n    return this.emit('error', new Error('bad save target: '+where))\r\n  }\r\n\r\n  if (target.source) {\r\n    var pref = target.prefix || ''\r\n    Object.keys(target.data).forEach(function (k) {\r\n      target.source[pref + k] = target.data[k]\r\n    })\r\n    return this\r\n  }\r\n\r\n  var type = type || target.type\r\n  var data = target.data\r\n  if (target.type === 'json') {\r\n    data = JSON.stringify(data)\r\n  } else {\r\n    data = ini.stringify(data)\r\n  }\r\n\r\n  this._saving ++\r\n  fs.writeFile(target.path, data, 'utf8', function (er) {\r\n    this._saving --\r\n    if (er) {\r\n      if (cb) return cb(er)\r\n      else return this.emit('error', er)\r\n    }\r\n    if (this._saving === 0) {\r\n      if (cb) cb()\r\n      this.emit('save')\r\n    }\r\n  }.bind(this))\r\n  return this\r\n}\r\n\r\nConfigChain.prototype.addFile = function (file, type, name) {\r\n  name = name || file\r\n  var marker = {__source__:name}\r\n  this.sources[name] = { path: file, type: type }\r\n  this.push(marker)\r\n  this._await()\r\n  fs.readFile(file, 'utf8', function (er, data) {\r\n    if (er) this.emit('error', er)\r\n    this.addString(data, file, type, marker)\r\n  }.bind(this))\r\n  return this\r\n}\r\n\r\nConfigChain.prototype.addEnv = function (prefix, env, name) {\r\n  name = name || 'env'\r\n  var data = exports.env(prefix, env)\r\n  this.sources[name] = { data: data, source: env, prefix: prefix }\r\n  return this.add(data, name)\r\n}\r\n\r\nConfigChain.prototype.addUrl = function (req, type, name) {\r\n  this._await()\r\n  var href = url.format(req)\r\n  name = name || href\r\n  var marker = {__source__:name}\r\n  this.sources[name] = { href: href, type: type }\r\n  this.push(marker)\r\n  http.request(req, function (res) {\r\n    var c = []\r\n    var ct = res.headers['content-type']\r\n    if (!type) {\r\n      type = ct.indexOf('json') !== -1 ? 'json'\r\n           : ct.indexOf('ini') !== -1 ? 'ini'\r\n           : href.match(/\\.json$/) ? 'json'\r\n           : href.match(/\\.ini$/) ? 'ini'\r\n           : null\r\n      marker.type = type\r\n    }\r\n\r\n    res.on('data', c.push.bind(c))\r\n    .on('end', function () {\r\n      this.addString(Buffer.concat(c), href, type, marker)\r\n    }.bind(this))\r\n    .on('error', this.emit.bind(this, 'error'))\r\n\r\n  }.bind(this))\r\n  .on('error', this.emit.bind(this, 'error'))\r\n  .end()\r\n\r\n  return this\r\n}\r\n\r\nConfigChain.prototype.addString = function (data, file, type, marker) {\r\n  data = this.parse(data, file, type)\r\n  this.add(data, marker)\r\n  return this\r\n}\r\n\r\nConfigChain.prototype.add = function (data, marker) {\r\n  if (marker && typeof marker === 'object') {\r\n    var i = this.list.indexOf(marker)\r\n    if (i === -1) {\r\n      return this.emit('error', new Error('bad marker'))\r\n    }\r\n    this.splice(i, 1, data)\r\n    marker = marker.__source__\r\n    this.sources[marker] = this.sources[marker] || {}\r\n    this.sources[marker].data = data\r\n    // we were waiting for this.  maybe emit 'load'\r\n    this._resolve()\r\n  } else {\r\n    if (typeof marker === 'string') {\r\n      this.sources[marker] = this.sources[marker] || {}\r\n      this.sources[marker].data = data\r\n    }\r\n    // trigger the load event if nothing was already going to do so.\r\n    this._await()\r\n    this.push(data)\r\n    process.nextTick(this._resolve.bind(this))\r\n  }\r\n  return this\r\n}\r\n\r\nConfigChain.prototype.parse = exports.parse\r\n\r\nConfigChain.prototype._await = function () {\r\n  this._awaiting++\r\n}\r\n\r\nConfigChain.prototype._resolve = function () {\r\n  this._awaiting--\r\n  if (this._awaiting === 0) this.emit('load', this)\r\n}\r\n"]},"metadata":{},"sourceType":"script"}