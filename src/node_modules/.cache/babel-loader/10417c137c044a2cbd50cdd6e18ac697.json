{"ast":null,"code":"'use strict';\n\nconst BB = require('bluebird');\n\nconst contentPath = require('./path');\n\nconst fixOwner = require('../util/fix-owner');\n\nconst fs = require('graceful-fs');\n\nconst moveFile = require('../util/move-file');\n\nconst PassThrough = require('stream').PassThrough;\n\nconst path = require('path');\n\nconst pipe = BB.promisify(require('mississippi').pipe);\nconst rimraf = BB.promisify(require('rimraf'));\n\nconst ssri = require('ssri');\n\nconst to = require('mississippi').to;\n\nconst uniqueFilename = require('unique-filename');\n\nconst Y = require('../util/y.js');\n\nconst writeFileAsync = BB.promisify(fs.writeFile);\nmodule.exports = write;\n\nfunction write(cache, data, opts) {\n  opts = opts || {};\n\n  if (opts.algorithms && opts.algorithms.length > 1) {\n    throw new Error(Y`opts.algorithms only supports a single algorithm for now`);\n  }\n\n  if (typeof opts.size === 'number' && data.length !== opts.size) {\n    return BB.reject(sizeError(opts.size, data.length));\n  }\n\n  const sri = ssri.fromData(data, {\n    algorithms: opts.algorithms\n  });\n\n  if (opts.integrity && !ssri.checkData(data, opts.integrity, opts)) {\n    return BB.reject(checksumError(opts.integrity, sri));\n  }\n\n  return BB.using(makeTmp(cache, opts), tmp => writeFileAsync(tmp.target, data, {\n    flag: 'wx'\n  }).then(() => moveToDestination(tmp, cache, sri, opts))).then(() => ({\n    integrity: sri,\n    size: data.length\n  }));\n}\n\nmodule.exports.stream = writeStream;\n\nfunction writeStream(cache, opts) {\n  opts = opts || {};\n  const inputStream = new PassThrough();\n  let inputErr = false;\n\n  function errCheck() {\n    if (inputErr) {\n      throw inputErr;\n    }\n  }\n\n  let allDone;\n  const ret = to((c, n, cb) => {\n    if (!allDone) {\n      allDone = handleContent(inputStream, cache, opts, errCheck);\n    }\n\n    inputStream.write(c, n, cb);\n  }, cb => {\n    inputStream.end(() => {\n      if (!allDone) {\n        const e = new Error(Y`Cache input stream was empty`);\n        e.code = 'ENODATA';\n        return ret.emit('error', e);\n      }\n\n      allDone.then(res => {\n        res.integrity && ret.emit('integrity', res.integrity);\n        res.size !== null && ret.emit('size', res.size);\n        cb();\n      }, e => {\n        ret.emit('error', e);\n      });\n    });\n  });\n  ret.once('error', e => {\n    inputErr = e;\n  });\n  return ret;\n}\n\nfunction handleContent(inputStream, cache, opts, errCheck) {\n  return BB.using(makeTmp(cache, opts), tmp => {\n    errCheck();\n    return pipeToTmp(inputStream, cache, tmp.target, opts, errCheck).then(res => {\n      return moveToDestination(tmp, cache, res.integrity, opts, errCheck).then(() => res);\n    });\n  });\n}\n\nfunction pipeToTmp(inputStream, cache, tmpTarget, opts, errCheck) {\n  return BB.resolve().then(() => {\n    let integrity;\n    let size;\n    const hashStream = ssri.integrityStream({\n      integrity: opts.integrity,\n      algorithms: opts.algorithms,\n      size: opts.size\n    }).on('integrity', s => {\n      integrity = s;\n    }).on('size', s => {\n      size = s;\n    });\n    const outStream = fs.createWriteStream(tmpTarget, {\n      flags: 'wx'\n    });\n    errCheck();\n    return pipe(inputStream, hashStream, outStream).then(() => {\n      return {\n        integrity,\n        size\n      };\n    }).catch(err => {\n      return rimraf(tmpTarget).then(() => {\n        throw err;\n      });\n    });\n  });\n}\n\nfunction makeTmp(cache, opts) {\n  const tmpTarget = uniqueFilename(path.join(cache, 'tmp'), opts.tmpPrefix);\n  return fixOwner.mkdirfix(cache, path.dirname(tmpTarget)).then(() => ({\n    target: tmpTarget,\n    moved: false\n  })).disposer(tmp => !tmp.moved && rimraf(tmp.target));\n}\n\nfunction moveToDestination(tmp, cache, sri, opts, errCheck) {\n  errCheck && errCheck();\n  const destination = contentPath(cache, sri);\n  const destDir = path.dirname(destination);\n  return fixOwner.mkdirfix(cache, destDir).then(() => {\n    errCheck && errCheck();\n    return moveFile(tmp.target, destination);\n  }).then(() => {\n    errCheck && errCheck();\n    tmp.moved = true;\n    return fixOwner.chownr(cache, destination);\n  });\n}\n\nfunction sizeError(expected, found) {\n  var err = new Error(Y`Bad data size: expected inserted data to be ${expected} bytes, but got ${found} instead`);\n  err.expected = expected;\n  err.found = found;\n  err.code = 'EBADSIZE';\n  return err;\n}\n\nfunction checksumError(expected, found) {\n  var err = new Error(Y`Integrity check failed:\n  Wanted: ${expected}\n   Found: ${found}`);\n  err.code = 'EINTEGRITY';\n  err.expected = expected;\n  err.found = found;\n  return err;\n}","map":{"version":3,"sources":["D:/node_modules/npm/node_modules/cacache/lib/content/write.js"],"names":["BB","require","contentPath","fixOwner","fs","moveFile","PassThrough","path","pipe","promisify","rimraf","ssri","to","uniqueFilename","Y","writeFileAsync","writeFile","module","exports","write","cache","data","opts","algorithms","length","Error","size","reject","sizeError","sri","fromData","integrity","checkData","checksumError","using","makeTmp","tmp","target","flag","then","moveToDestination","stream","writeStream","inputStream","inputErr","errCheck","allDone","ret","c","n","cb","handleContent","end","e","code","emit","res","once","pipeToTmp","tmpTarget","resolve","hashStream","integrityStream","on","s","outStream","createWriteStream","flags","catch","err","join","tmpPrefix","mkdirfix","dirname","moved","disposer","destination","destDir","chownr","expected","found"],"mappings":"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","sourcesContent":["'use strict'\r\n\r\nconst BB = require('bluebird')\r\n\r\nconst contentPath = require('./path')\r\nconst fixOwner = require('../util/fix-owner')\r\nconst fs = require('graceful-fs')\r\nconst moveFile = require('../util/move-file')\r\nconst PassThrough = require('stream').PassThrough\r\nconst path = require('path')\r\nconst pipe = BB.promisify(require('mississippi').pipe)\r\nconst rimraf = BB.promisify(require('rimraf'))\r\nconst ssri = require('ssri')\r\nconst to = require('mississippi').to\r\nconst uniqueFilename = require('unique-filename')\r\nconst Y = require('../util/y.js')\r\n\r\nconst writeFileAsync = BB.promisify(fs.writeFile)\r\n\r\nmodule.exports = write\r\nfunction write (cache, data, opts) {\r\n  opts = opts || {}\r\n  if (opts.algorithms && opts.algorithms.length > 1) {\r\n    throw new Error(\r\n      Y`opts.algorithms only supports a single algorithm for now`\r\n    )\r\n  }\r\n  if (typeof opts.size === 'number' && data.length !== opts.size) {\r\n    return BB.reject(sizeError(opts.size, data.length))\r\n  }\r\n  const sri = ssri.fromData(data, {\r\n    algorithms: opts.algorithms\r\n  })\r\n  if (opts.integrity && !ssri.checkData(data, opts.integrity, opts)) {\r\n    return BB.reject(checksumError(opts.integrity, sri))\r\n  }\r\n  return BB.using(makeTmp(cache, opts), tmp => (\r\n    writeFileAsync(\r\n      tmp.target, data, { flag: 'wx' }\r\n    ).then(() => (\r\n      moveToDestination(tmp, cache, sri, opts)\r\n    ))\r\n  )).then(() => ({ integrity: sri, size: data.length }))\r\n}\r\n\r\nmodule.exports.stream = writeStream\r\nfunction writeStream (cache, opts) {\r\n  opts = opts || {}\r\n  const inputStream = new PassThrough()\r\n  let inputErr = false\r\n  function errCheck () {\r\n    if (inputErr) { throw inputErr }\r\n  }\r\n\r\n  let allDone\r\n  const ret = to((c, n, cb) => {\r\n    if (!allDone) {\r\n      allDone = handleContent(inputStream, cache, opts, errCheck)\r\n    }\r\n    inputStream.write(c, n, cb)\r\n  }, cb => {\r\n    inputStream.end(() => {\r\n      if (!allDone) {\r\n        const e = new Error(Y`Cache input stream was empty`)\r\n        e.code = 'ENODATA'\r\n        return ret.emit('error', e)\r\n      }\r\n      allDone.then(res => {\r\n        res.integrity && ret.emit('integrity', res.integrity)\r\n        res.size !== null && ret.emit('size', res.size)\r\n        cb()\r\n      }, e => {\r\n        ret.emit('error', e)\r\n      })\r\n    })\r\n  })\r\n  ret.once('error', e => {\r\n    inputErr = e\r\n  })\r\n  return ret\r\n}\r\n\r\nfunction handleContent (inputStream, cache, opts, errCheck) {\r\n  return BB.using(makeTmp(cache, opts), tmp => {\r\n    errCheck()\r\n    return pipeToTmp(\r\n      inputStream, cache, tmp.target, opts, errCheck\r\n    ).then(res => {\r\n      return moveToDestination(\r\n        tmp, cache, res.integrity, opts, errCheck\r\n      ).then(() => res)\r\n    })\r\n  })\r\n}\r\n\r\nfunction pipeToTmp (inputStream, cache, tmpTarget, opts, errCheck) {\r\n  return BB.resolve().then(() => {\r\n    let integrity\r\n    let size\r\n    const hashStream = ssri.integrityStream({\r\n      integrity: opts.integrity,\r\n      algorithms: opts.algorithms,\r\n      size: opts.size\r\n    }).on('integrity', s => {\r\n      integrity = s\r\n    }).on('size', s => {\r\n      size = s\r\n    })\r\n    const outStream = fs.createWriteStream(tmpTarget, {\r\n      flags: 'wx'\r\n    })\r\n    errCheck()\r\n    return pipe(inputStream, hashStream, outStream).then(() => {\r\n      return { integrity, size }\r\n    }).catch(err => {\r\n      return rimraf(tmpTarget).then(() => { throw err })\r\n    })\r\n  })\r\n}\r\n\r\nfunction makeTmp (cache, opts) {\r\n  const tmpTarget = uniqueFilename(path.join(cache, 'tmp'), opts.tmpPrefix)\r\n  return fixOwner.mkdirfix(\r\n    cache, path.dirname(tmpTarget)\r\n  ).then(() => ({\r\n    target: tmpTarget,\r\n    moved: false\r\n  })).disposer(tmp => (!tmp.moved && rimraf(tmp.target)))\r\n}\r\n\r\nfunction moveToDestination (tmp, cache, sri, opts, errCheck) {\r\n  errCheck && errCheck()\r\n  const destination = contentPath(cache, sri)\r\n  const destDir = path.dirname(destination)\r\n\r\n  return fixOwner.mkdirfix(\r\n    cache, destDir\r\n  ).then(() => {\r\n    errCheck && errCheck()\r\n    return moveFile(tmp.target, destination)\r\n  }).then(() => {\r\n    errCheck && errCheck()\r\n    tmp.moved = true\r\n    return fixOwner.chownr(cache, destination)\r\n  })\r\n}\r\n\r\nfunction sizeError (expected, found) {\r\n  var err = new Error(Y`Bad data size: expected inserted data to be ${expected} bytes, but got ${found} instead`)\r\n  err.expected = expected\r\n  err.found = found\r\n  err.code = 'EBADSIZE'\r\n  return err\r\n}\r\n\r\nfunction checksumError (expected, found) {\r\n  var err = new Error(Y`Integrity check failed:\r\n  Wanted: ${expected}\r\n   Found: ${found}`)\r\n  err.code = 'EINTEGRITY'\r\n  err.expected = expected\r\n  err.found = found\r\n  return err\r\n}\r\n"]},"metadata":{},"sourceType":"script"}